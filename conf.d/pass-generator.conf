# ============================================================================
# Configuración Nginx - Pass Generator (Optimizada)
# Compatible con Virtual Server NIS y múltiples dominios
# Solo HTTPS (Puerto 443) - Seguridad mejorada
# ============================================================================

# ----------------------------------------------------------------------------
# HTTPS Server - Frontend (mobilepass.itass.cloud)
# ----------------------------------------------------------------------------
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name mobilepass.itass.cloud;

    # Certificados SSL (wildcard *.itass.cloud)
    ssl_certificate /etc/ssl/itass/certificate.crt;
    ssl_certificate_key /etc/ssl/itass/private.key;

    # Configuración SSL común
    include /etc/nginx/conf.d/common-ssl.conf;

    # Headers de seguridad comunes
    include /etc/nginx/conf.d/common-security-headers.conf;

    # Logs específicos (opcional)
    access_log /var/log/nginx/frontend-access.log main;
    error_log /var/log/nginx/frontend-error.log warn;

    # Health check
    location /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "frontend-healthy\n";
    }

    # Proxy al frontend (Next.js)
    location / {
        proxy_pass http://frontend:3000;
        
        # Headers comunes de proxy
        include /etc/nginx/conf.d/common-proxy-headers.conf;
        
        # Timeouts para frontend
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 86400s;  # 24h para WebSocket/SSE
    }
}

# ----------------------------------------------------------------------------
# HTTPS Server - Backend API (wallet.itass.cloud)
# ----------------------------------------------------------------------------
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name wallet.itass.cloud;

    # Certificados SSL (wildcard *.itass.cloud)
    ssl_certificate /etc/ssl/itass/certificate.crt;
    ssl_certificate_key /etc/ssl/itass/private.key;

    # Configuración SSL común
    include /etc/nginx/conf.d/common-ssl.conf;

    # Headers de seguridad comunes
    include /etc/nginx/conf.d/common-security-headers.conf;

    # Logs específicos (opcional)
    access_log /var/log/nginx/backend-access.log main;
    error_log /var/log/nginx/backend-error.log warn;

    # Health check
    location /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "backend-healthy\n";
    }

    # Rate limiting para autenticación (mayor restricción)
    location /api/auth {
        limit_req zone=auth burst=5 nodelay;
        limit_req_log_level warn;
        
        proxy_pass http://backend:3001;
        
        # Headers comunes de proxy
        include /etc/nginx/conf.d/common-proxy-headers.conf;
        
        # Timeouts para autenticación
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Rate limiting para API general
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        limit_req_log_level warn;
        
        proxy_pass http://backend:3001;
        
        # Headers comunes de proxy
        include /etc/nginx/conf.d/common-proxy-headers.conf;
        
        # Timeouts para API
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Proxy al backend (rutas no API)
    location / {
        proxy_pass http://backend:3001;
        
        # Headers comunes de proxy
        include /etc/nginx/conf.d/common-proxy-headers.conf;
        
        # Timeouts estándar
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}
